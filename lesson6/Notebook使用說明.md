# 📓 lesson6_1.ipynb 使用說明

## ✅ 問題已修復

- ✅ **SyntaxError 已修復**
- ✅ **重複程式碼已清除**
- ✅ **Mosquitto 已重啟**
- ✅ **Notebook 已重新創建**
- ✅ **舊版本已備份為 `lesson6_1_backup.ipynb`**

---

## 🎯 正確使用步驟

### **步驟 1：重新載入 Jupyter**

1. **在瀏覽器中按 F5 刷新頁面**
2. 或重新開啟 `lesson6_1.ipynb`

### **步驟 2：重啟 Kernel**

**重要！** 每次測試前必須重啟：

- 點擊選單：**`Kernel`** → **`Restart Kernel`** → **`Restart`**
- 或按兩次 `0`（在命令模式下，按 `Esc` 後）

### **步驟 3：按順序執行 Cells**

#### **正確順序：**

```
1️⃣ Cell 1 - 匯入套件
   執行後看到：✅ 套件匯入成功！
   ↓
2️⃣ Cell 2 - 設定配置
   執行後看到：📡 MQTT 連線設定
   ↓
3️⃣ Cell 3 - 定義回調
   執行後看到：✅ 回調函數定義完成
   ↓
4️⃣ Cell 4 - 建立連線 ⚠️ 只執行一次！
   執行後看到：
   🔌 正在連接到 localhost:1883...
   ✅ 成功連接到 MQTT Broker
   ✅ MQTT 客戶端已就緒
   💡 現在可以執行下方的發布測試 cells
   ↓
5️⃣ Cell 5 - 測試數據生成
   執行後看到：📊 測試數據範例
   ↓
6️⃣ Cell 6/7/8 - 發布測試（可重複執行）
   - Cell 6: 發布單筆數據
   - Cell 7: 批次發布 5 筆數據
   - Cell 8: 發布自訂數據
```

### **步驟 4：測試發布**

選擇以下任一 cell 執行：

#### **選項 A：發布單筆數據（Cell 6）**
執行後應該看到：
```
============================================================
📤 發布單筆測試數據
============================================================
✅ 發布成功！
   🌡️  溫度: 24.5°C
   💧 濕度: 65.3%
   💡 電燈: 開
  ✓ 訊息已發布 (ID: 1)
```

#### **選項 B：批次發布 5 筆數據（Cell 7）**
執行後應該看到：
```
============================================================
📤 批次發布 5 筆測試數據（間隔 1 秒）
============================================================

[1/5] 發布數據:
  🌡️  溫度: 22.33°C
  💧 濕度: 58.12%
  💡 電燈: 開
  ✓ 訊息已發布 (ID: 2)

[2/5] 發布數據:
...
```

#### **選項 C：發布自訂數據（Cell 8）**
可以修改函數參數：
```python
publish_custom_data(25.5, 60.0, "開")
```

### **步驟 5：結束測試**

執行 **Cell 9 - 清理連線**：
```
🧹 正在關閉連線...
✅ 連線已關閉
👋 已正常斷開連線
```

---

## ⚠️ 重要注意事項

### **禁止操作：**

❌ **不要重複執行 Cell 4**
   - Cell 4 只能執行一次
   - 重複執行會導致連線衝突

❌ **不要跳著執行**
   - 必須按順序：1 → 2 → 3 → 4 → 5 → 6/7/8

❌ **不要在沒有重啟 Kernel 的情況下重新連線**
   - 如需重新開始，請先重啟 Kernel

### **如果 Cell 4 顯示警告：**

如果執行 Cell 4 時看到：
```
⚠️ 警告：client 已存在！請重啟 Kernel 後再執行
   操作：Kernel → Restart Kernel → Restart
```

**請立即：**
1. 點擊 `Kernel` → `Restart Kernel` → `Restart`
2. 重新從 Cell 1 開始執行

---

## 🔍 錯誤診斷

### **錯誤 1：`name 'client' is not defined`**

**原因：** 沒有執行 Cell 4

**解決：**
1. 重啟 Kernel
2. 依序執行 Cell 1 → 2 → 3 → 4
3. 再執行發布 cells

### **錯誤 2：重複連線和斷線**

**原因：** Cell 4 被重複執行

**解決：**
1. 重啟 Kernel
2. 重新按順序執行
3. Cell 4 只執行一次

### **錯誤 3：SyntaxError**

**原因：** Notebook 損壞

**解決：**
- 已經修復！重新載入頁面即可

---

## 🧪 測試驗證

### **如何確認連線成功？**

執行 Cell 4 後，應該看到：
```
✅ 成功連接到 MQTT Broker
✅ MQTT 客戶端已就緒
```

**而不是：**
```
⚠️ 意外斷線，錯誤碼: Unspecified error
```

### **如何確認發布成功？**

執行 Cell 6/7/8 後，應該看到：
```
✅ 發布成功！
  ✓ 訊息已發布 (ID: X)
```

**而不是：**
```
❌ 錯誤: name 'client' is not defined
```

---

## 🚀 與 lesson6_2.ipynb 配合測試

### **完整測試流程：**

#### **1. 開啟訂閱者（lesson6_2.ipynb）**
- 開啟新分頁
- 重啟 Kernel
- 執行 Cell 1 → 2 → 3 → 4
- 看到 "✅ MQTT 訂閱者已就緒"

#### **2. 開啟發布者（lesson6_1.ipynb）**
- 開啟新分頁
- 重啟 Kernel
- 執行 Cell 1 → 2 → 3 → 4
- 執行 Cell 7（批次發布）

#### **3. 查看結果**
- 切換回 lesson6_2.ipynb
- 應該會看到收到的訊息

---

## 💡 最佳實踐

### **推薦工作流程：**

**初學者/測試階段：**
```bash
# 使用命令列腳本（最可靠）
cd /home/pi/Documents/GiHub/20251026-raspberry_pi_pico

# 終端機 1
uv run python lesson6/mqtt_subscribe_test.py

# 終端機 2
uv run python lesson6/mqtt_test_simple.py
```

**熟練後/演示階段：**
- 使用 Jupyter Notebook
- 嚴格遵守操作規則
- 出問題立即切換到命令列

---

## 📊 檔案結構

```
lesson6/
├── lesson6_1.ipynb           ← 新版本（乾淨）
├── lesson6_1_backup.ipynb    ← 舊版本備份
├── lesson6_2.ipynb           ← 訂閱者
├── mqtt_test_simple.py       ← 命令列發布者
├── mqtt_subscribe_test.py    ← 命令列訂閱者
├── test_mqtt.sh              ← 一鍵測試腳本
├── Notebook使用說明.md       ← 本文件
├── 快速開始.md               ← 快速指南
└── 緊急修復指南.md           ← 問題排解
```

---

## ✅ 檢查清單

使用前檢查：
- [ ] 已重啟 Jupyter 或刷新頁面
- [ ] 已重啟 Kernel
- [ ] Mosquitto 正在運行（`systemctl status mosquitto`）
- [ ] 了解正確的執行順序

執行中檢查：
- [ ] Cell 1-4 依序執行成功
- [ ] 看到 "✅ MQTT 客戶端已就緒"
- [ ] 沒有看到重複連線/斷線訊息
- [ ] Cell 4 只執行了一次

測試完成：
- [ ] 執行 Cell 9 清理連線
- [ ] 可以重啟 Kernel 準備下次測試

---

**現在可以開始測試了！** 🎉

記住：**每次測試前重啟 Kernel，Cell 4 只執行一次！**





