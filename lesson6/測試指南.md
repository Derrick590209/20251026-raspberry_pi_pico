# 🎯 MQTT Publish/Subscribe 測試指南

## 📋 測試前準備

### 1️⃣ 確認 MQTT Broker 運行中

```bash
# 檢查 Mosquitto 狀態
sudo systemctl status mosquitto

# 如果未運行，啟動它
sudo systemctl start mosquitto
```

### 2️⃣ 開啟 Jupyter Notebook

```bash
cd /home/pi/Documents/GiHub/20251026-raspberry_pi_pico
jupyter notebook
```

---

## 🚀 測試步驟（推薦方式）

### 📥 步驟 1：啟動訂閱者（lesson6_2.ipynb）

1. **開啟 `lesson6/lesson6_2.ipynb`**

2. **按順序執行以下 Cells：**

```
Cell 1: 匯入套件
Cell 2: MQTT 配置
Cell 3: 定義回調函數
Cell 4: 建立連線並訂閱 ⭐
```

3. **看到以下訊息表示成功：**

```
✅ MQTT 訂閱者已就緒，等待訊息...
```

---

### 📤 步驟 2：啟動發布者（lesson6_1.ipynb）

1. **在新分頁開啟 `lesson6/lesson6_1.ipynb`**
   - 或使用 Jupyter 的 "File → Open in New Browser Tab"

2. **按順序執行以下 Cells：**

```
Cell 1: 匯入套件
Cell 2: MQTT 配置
Cell 3: 定義回調函數
Cell 4: 建立連線 ⭐
```

3. **看到以下訊息表示成功：**

```
✅ MQTT 客戶端已就緒
💡 現在可以執行下方的發布測試 cells
```

---

### 📨 步驟 3：發送測試訊息

**在 `lesson6_1.ipynb` 中執行以下任一測試 Cell：**

#### 🔹 選項 1：發布單筆訊息（Cell 6）
```
執行 Cell 6 → 發送 1 筆隨機數據
```

#### 🔹 選項 2：批次發布 5 筆訊息（Cell 7）⭐ 推薦
```
執行 Cell 7 → 發送 5 筆隨機數據（間隔 1 秒）
```

#### 🔹 選項 3：發布自訂數據（Cell 8）
```
執行 Cell 8 → 發送自訂的溫度、濕度數據
```

---

### 👀 步驟 4：查看接收結果

**切換回 `lesson6_2.ipynb` 分頁：**

1. **自動顯示接收到的訊息**

   訊息會即時顯示在 Cell 4 的輸出區域：

   ```
   ============================================================
   📩 收到訊息 #1
   ============================================================
      主題: 客廳/感測器
      時間: 2025-12-13 09:30:15
      🌡️  溫度: 25.5°C
      💧 濕度: 60.0%
      💡 電燈: 開
      📱 裝置: Jupyter 測試裝置
   ```

2. **查看統計資訊（Cell 5）**

   執行 Cell 5 可以看到：
   - 總接收訊息數
   - 最近訊息記錄
   - 溫度/濕度統計分析
   - 電燈狀態統計

---

## 🧪 測試範例

### 範例 1：基本測試

1. **訂閱者** → 執行 Cell 1-4 → 等待訊息
2. **發布者** → 執行 Cell 1-4 → 建立連線
3. **發布者** → 執行 Cell 6 → 發送 1 筆訊息
4. **訂閱者** → 看到即時接收的訊息 ✅

---

### 範例 2：批次測試

1. **訂閱者** → 執行 Cell 1-4 → 等待訊息
2. **發布者** → 執行 Cell 1-4 → 建立連線
3. **發布者** → 執行 Cell 7 → 發送 5 筆訊息
4. **訂閱者** → 看到 5 筆訊息陸續顯示 ✅
5. **訂閱者** → 執行 Cell 5 → 查看統計 ✅

---

### 範例 3：多次發布測試

1. **訂閱者** → 執行 Cell 1-4 → 等待訊息
2. **發布者** → 執行 Cell 1-4 → 建立連線
3. **發布者** → 執行 Cell 7 → 發送 5 筆訊息
4. **發布者** → 執行 Cell 6 → 發送 1 筆訊息
5. **發布者** → 執行 Cell 8 → 發送自訂數據
6. **訂閱者** → 看到共 7 筆訊息 ✅
7. **訂閱者** → 執行 Cell 5 → 查看統計分析 ✅

---

## 🧹 測試結束後

### 清理連線

**兩個 Notebook 都要執行清理：**

1. **lesson6_1.ipynb** → 執行 Cell 9（清理連線）
2. **lesson6_2.ipynb** → 執行 Cell 6（清理連線）

### 重新測試

如果要重新開始測試：

1. **重啟 Kernel**
   - Jupyter: `Kernel → Restart`
   
2. **重新執行所有 Cells**
   - 從 Cell 1 開始按順序執行

---

## ⚠️ 常見問題

### 問題 1：訂閱者沒收到訊息

**檢查清單：**
- ✅ 訂閱者的 Cell 4 已執行？
- ✅ 看到 "MQTT 訂閱者已就緒" 訊息？
- ✅ 發布者也已連線？
- ✅ 兩者的 TOPIC 相同？（預設都是 `客廳/感測器`）

**解決方法：**
```bash
# 1. 檢查 Mosquitto 日誌
sudo tail -f /var/log/mosquitto/mosquitto.log

# 2. 重啟 Kernel 後重新執行
```

---

### 問題 2：出現 "client 已存在" 警告

**原因：** Cell 4 被重複執行了

**解決方法：**
1. 執行清理 Cell（Cell 9 或 Cell 6）
2. 重啟 Kernel
3. 從 Cell 1 開始重新執行

---

### 問題 3：連線失敗

**檢查清單：**
```bash
# 1. 確認 Mosquitto 運行中
sudo systemctl status mosquitto

# 2. 確認可以連線
mosquitto_sub -h localhost -t "test" -v

# 3. 檢查防火牆
sudo ufw status
```

---

### 問題 4：SyntaxError 錯誤

**原因：** Cell 0（Markdown cell）被誤執行為程式碼

**解決方法：**
- 在 Jupyter 中，Cell 0 應該顯示為格式化的文字
- 如果顯示錯誤，請重新載入 Notebook（F5）

---

## 📊 預期結果

### ✅ 成功的測試應該看到：

**發布者（lesson6_1.ipynb）：**
```
✅ MQTT 客戶端已就緒
✅ 發布成功！
   🌡️  溫度: 25.5°C
   💧 濕度: 60.0%
   💡 電燈: 開
  ✓ 訊息已發布 (ID: 1)
```

**訂閱者（lesson6_2.ipynb）：**
```
============================================================
📩 收到訊息 #1
============================================================
   主題: 客廳/感測器
   時間: 2025-12-13 09:30:15
   🌡️  溫度: 25.5°C
   💧 濕度: 60.0%
   💡 電燈: 開
   📱 裝置: Jupyter 測試裝置
```

---

## 🎓 進階測試

### 測試不同的主題

**修改 Cell 2 的 TOPIC：**

```python
# 發布者和訂閱者都要一致
TOPIC = "房間/溫度"  # 自訂主題
```

### 訂閱所有主題

**訂閱者的 Cell 2：**

```python
TOPIC = "#"  # 使用 # 訂閱所有主題
```

### 測試 QoS 等級

**修改 QoS：**

```python
# 發布時
client.publish(TOPIC, json_data, qos=2)  # QoS 0, 1, 2

# 訂閱時
client.subscribe(TOPIC, qos=2)
```

---

## 💡 提示

1. **先啟動訂閱者，再啟動發布者** → 確保不會漏收訊息
2. **Cell 4 只執行一次** → 避免重複連線
3. **測試結束記得清理** → 避免連線殘留
4. **查看統計資訊** → 了解測試結果

---

## 📞 需要幫助？

如果測試過程中遇到問題：

1. 檢查 Mosquitto 日誌：
   ```bash
   sudo tail -f /var/log/mosquitto/mosquitto.log
   ```

2. 重啟所有服務：
   ```bash
   sudo systemctl restart mosquitto
   jupyter notebook stop
   jupyter notebook
   ```

3. 確認網路連線正常

---

## ✨ 測試成功！

如果你看到：
- ✅ 訂閱者接收到訊息
- ✅ 發布者成功發送
- ✅ 統計資訊正確顯示

**恭喜！MQTT Publish/Subscribe 測試成功！** 🎉


