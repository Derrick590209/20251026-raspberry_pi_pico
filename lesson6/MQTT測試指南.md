# MQTT Publish/Subscribe 測試指南

## 📋 測試環境確認

### ✅ 已確認項目
- Mosquitto Broker: ✅ 運行中
- IP 位址: 192.168.1.16
- 埠號: 1883
- paho-mqtt: ✅ 已安裝 (v2.1.0)

---

## 🧪 測試方法

### **方法 1：使用 Jupyter Notebook（推薦）**

#### **步驟 1：啟動 Jupyter Notebook**

```bash
cd /home/pi/Documents/GiHub/20251026-raspberry_pi_pico
uv run jupyter notebook
```

#### **步驟 2：開啟訂閱者（Subscriber）**

1. 在瀏覽器中開啟 `lesson6/lesson6_2.ipynb`
2. 按順序執行以下 cells：
   - **Cell 1**: 匯入套件 ✅
   - **Cell 2**: 設定配置 ✅
   - **Cell 3**: 定義回調函數 ✅
   - **Cell 4**: 建立連線並訂閱 ✅

**預期結果：**
```
✅ 成功連接到 MQTT Broker
📬 已訂閱主題: 客廳/感測器
✅ 訂閱成功 (ID: 1)

============================================================
✅ MQTT 訂閱者已就緒，等待訊息...
============================================================
💡 提示：
   1. 此 cell 會持續運行並接收訊息
   2. 可以執行 lesson6_1.ipynb 來發布測試訊息
   3. 執行 Cell 5 查看統計資訊
   4. 執行 Cell 6 關閉連線
============================================================
```

#### **步驟 3：開啟發布者（Publisher）**

1. 開啟新的瀏覽器分頁
2. 開啟 `lesson6/lesson6_1.ipynb`
3. 按順序執行以下 cells：
   - **Cell 1**: 匯入套件 ✅
   - **Cell 2**: 設定配置 ✅
   - **Cell 3**: 定義回調函數 ✅
   - **Cell 4**: 建立連線 ✅

4. 執行測試功能：
   - **Cell 6**: 發布單筆測試數據
   - **Cell 7**: 批次發布 5 筆數據
   - **Cell 8**: 發布自訂數據

**預期結果：**
```
============================================================
📤 發布單筆測試數據
============================================================
✅ 發布成功！
   溫度: 25.86°C
   濕度: 47.26%
   電燈: 關
   時間: 2025-12-12T23:21:21.041609
📤 訊息已發布 (ID: 1)
```

#### **步驟 4：查看訂閱者收到的訊息**

切換回 `lesson6_2.ipynb` 分頁，應該會即時看到：

```
============================================================
📩 收到訊息 #1
============================================================
   主題: 客廳/感測器
   時間: 2025-12-12 23:21:21
   🌡️  溫度: 25.86°C
   💧 濕度: 47.26%
   💡 電燈: 關
   📱 裝置: Jupyter 測試裝置
   ⏰ 時間戳記: 2025-12-12T23:21:21.041609
```

#### **步驟 5：查看統計資訊**

在 `lesson6_2.ipynb` 執行 **Cell 5**：

```
============================================================
📊 MQTT 訊息統計
============================================================
📬 總接收訊息數: 5
📝 歷史記錄筆數: 5
🔌 連線狀態: ✅ 已連線
============================================================

📋 最近的訊息記錄：
...

📈 溫度統計：
  平均: 24.52°C
  最高: 28.74°C
  最低: 21.98°C

💧 濕度統計：
  平均: 56.47%
  最高: 73.05%
  最低: 46.75%
```

#### **步驟 6：結束測試**

1. 在 `lesson6_1.ipynb` 執行 **Cell 9** 關閉發布者
2. 在 `lesson6_2.ipynb` 執行 **Cell 6** 關閉訂閱者

---

### **方法 2：使用命令列工具測試**

#### **終端機 1：訂閱者**

```bash
mosquitto_sub -h localhost -t "客廳/感測器" -v
```

保持這個終端機運行，等待接收訊息。

#### **終端機 2：使用 Python 腳本發布**

```bash
cd /home/pi/Documents/GiHub/20251026-raspberry_pi_pico
uv run python lesson6/mqtt_test_simple.py
```

**預期輸出：**
```
======================================================================
🚀 MQTT PUBLISH 測試程式
======================================================================
📡 Broker: localhost:1883
📋 Topic: 客廳/感測器
🆔 Client ID: test_pub_12345_1765552291
======================================================================

🔌 正在連接...
✅ 成功連接到 MQTT Broker

======================================================================
📤 開始發布測試數據
======================================================================

[1/5] 發布數據:
  溫度: 24.44°C
  濕度: 64.36%
  電燈: 關
  ✓ 訊息已發布 (ID: 1)
...
```

同時在終端機 1 應該會看到接收到的 JSON 數據。

#### **終端機 2：使用命令列直接發布**

```bash
mosquitto_pub -h localhost -t "客廳/感測器" -m '{"temperature": 25.5, "humidity": 60, "light_status": "開"}'
```

---

## 🐛 常見問題排解

### **問題 1：連線後立即斷線**

**症狀：**
```
✅ 成功連接到 MQTT Broker
⚠️ 意外斷線，錯誤碼: Unspecified error
```

**解決方法：**
1. 重新執行 Cell 2（配置）生成新的 CLIENT_ID
2. 確保沒有重複執行 Cell 4（連線 cell）
3. 如果問題持續，先執行清理 cell，等待 2 秒後再重新連線

### **問題 2：訊息沒有接收到**

**檢查項目：**
1. 確認訂閱者的 TOPIC 和發布者的 TOPIC 是否一致
2. 確認兩者都連接到同一個 Broker
3. 檢查 Mosquitto 日誌：
   ```bash
   sudo tail -f /var/log/mosquitto/mosquitto.log
   ```

### **問題 3：Broker 未運行**

**檢查狀態：**
```bash
systemctl status mosquitto
```

**啟動 Broker：**
```bash
sudo systemctl start mosquitto
sudo systemctl enable mosquitto
```

---

## 📊 測試場景

### **場景 1：基本功能測試**
1. 啟動訂閱者
2. 發布 1 筆測試數據
3. 確認訂閱者收到訊息
4. 查看統計資訊

### **場景 2：批次數據測試**
1. 啟動訂閱者
2. 發布 5 筆測試數據（間隔 1 秒）
3. 確認訂閱者收到所有 5 筆
4. 查看溫度和濕度統計

### **場景 3：多訂閱者測試**
1. 開啟兩個 `lesson6_2.ipynb` 分頁（使用不同的 kernel）
2. 都啟動訂閱
3. 發布 1 筆數據
4. 確認兩個訂閱者都收到相同訊息

### **場景 4：不同主題測試**
1. 訂閱者訂閱 `"客廳/感測器"`
2. 發布者發布到 `"臥室/感測器"`
3. 確認訂閱者**不會**收到訊息
4. 修改訂閱者為 `"#"`（訂閱所有主題）
5. 再次發布，確認可以收到

### **場景 5：訂閱所有主題**
1. 修改 `lesson6_2.ipynb` Cell 2 的 TOPIC 為 `"#"`
2. 啟動訂閱者
3. 從不同主題發布訊息
4. 確認都能接收到

---

## 🎯 進階測試

### **測試 QoS 等級**

修改發布和訂閱的 QoS 等級，測試不同組合：

```python
# 在發布時
client.publish(TOPIC, json_data, qos=0)  # 最多一次
client.publish(TOPIC, json_data, qos=1)  # 至少一次
client.publish(TOPIC, json_data, qos=2)  # 恰好一次

# 在訂閱時
client.subscribe(TOPIC, qos=0)
client.subscribe(TOPIC, qos=1)
client.subscribe(TOPIC, qos=2)
```

### **測試保留訊息**

```python
# 發布保留訊息
client.publish(TOPIC, json_data, qos=1, retain=True)

# 後續連線的訂閱者會立即收到最後一筆保留訊息
```

### **測試遺囑訊息**

```python
# 設定遺囑訊息
client.will_set(TOPIC, "訂閱者異常斷線", qos=1)
```

---

## 📝 測試檢查清單

- [ ] Mosquitto Broker 正在運行
- [ ] 訂閱者成功連線並訂閱主題
- [ ] 發布者成功連線
- [ ] 發布單筆訊息成功
- [ ] 訂閱者即時收到訊息
- [ ] JSON 數據正確解析
- [ ] 批次發布 5 筆訊息成功
- [ ] 統計資訊顯示正確
- [ ] 溫度/濕度統計計算正確
- [ ] 清理連線正常

---

## 💡 提示

1. **建議先開啟訂閱者，再開啟發布者**，這樣不會錯過訊息
2. **使用 Ctrl+C** 可以中斷正在運行的 cell
3. **查看 Mosquitto 日誌**可以幫助診斷問題
4. **避免重複執行連線 cell**，以免造成 CLIENT_ID 衝突
5. **測試完記得關閉連線**，釋放資源

---

## 🚀 快速測試命令

```bash
# 一鍵測試（使用命令列）
# 終端機 1
mosquitto_sub -h localhost -t "客廳/感測器" -v

# 終端機 2
cd /home/pi/Documents/GiHub/20251026-raspberry_pi_pico
uv run python lesson6/mqtt_test_simple.py
```

---

測試愉快！🎉





